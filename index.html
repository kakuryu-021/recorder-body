<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Recorder-Body</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-color: #1c1c1e;
            --text-main: #ffffff;
            --text-sub: #ebebf599;
            --accent: #0a84ff;
            --border: #38383a;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding-top: 50px; 
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent;
        }

        header {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            text-align: center; padding: 15px 0;
            font-weight: bold; font-size: 1.1em;
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }

        .tab-content { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #tab-graph.active {
            display: flex;
            flex-direction: column;
            max-width: 100%; 
            padding: 10px 5px; 
            height: calc(100vh - 160px); 
            box-sizing: border-box;
        }
        .graph-header { display: flex; justify-content: flex-end; padding: 0 10px 10px 0; }
        select.graph-selector {
            background-color: var(--card-color); color: var(--text-main);
            border: 1px solid var(--border); padding: 8px 12px;
            border-radius: 8px; font-size: 1em; outline: none;
        }
        .chart-container { position: relative; flex-grow: 1; width: 100%; }

        .form-group { background: var(--card-color); padding: 12px 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 0.95em; font-weight: 500; }
        input[type="number"], input[type="date"] { 
            width: 45%; padding: 8px; text-align: right; font-size: 1em;
            background-color: transparent; border: none; color: var(--text-main); outline: none; color-scheme: dark;
        }
        input::placeholder { color: var(--text-sub); }
        
        button.save-btn { 
            width: 100%; padding: 16px; background-color: var(--accent); color: white; 
            border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 15px; 
        }

        .table-container { background: var(--card-color); border-radius: 12px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; white-space: nowrap; }
        th { color: var(--text-sub); font-weight: normal; }
        tr:last-child td { border-bottom: none; }

        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; 
            padding-top: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            box-sizing: border-box; z-index: 9999; 
        }
        .nav-item {
            flex: 1; text-align: center; padding: 5px 0; color: var(--text-sub);
            font-size: 0.75em; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 1.6em; }
    </style>
</head>
<body>

    <header>è¨˜éŒ²</header>

    <div id="tab-input" class="tab-content active">
        <div class="form-group" style="background: transparent; border: 1px solid var(--border);">
            <label>æ—¥ä»˜</label><input type="date" id="date" required style="width: 60%;">
        </div>
        <div class="form-group"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ä½“è„‚è‚ªç‡ (%)</label><input type="number" id="bodyfat" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ç­‹è‚‰é‡ (kg)</label><input type="number" id="muscle" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>åŸºç¤ä»£è¬é‡ (kcal)</label><input type="number" id="bmr" step="1" inputmode="numeric" placeholder="0"></div>
        <div class="form-group"><label>ãƒã‚¹ãƒˆ 0Â° (cm)</label><input type="number" id="bust0" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ã‚¢ãƒ³ãƒ€ãƒ¼ 0Â° (cm)</label><input type="number" id="underbust0" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ãƒã‚¹ãƒˆ 30Â° (cm)</label><input type="number" id="bust30" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ã‚¢ãƒ³ãƒ€ãƒ¼ 30Â° (cm)</label><input type="number" id="underbust30" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ã‚¦ã‚¨ã‚¹ãƒˆ (cm)</label><input type="number" id="waist" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>ãƒ’ãƒƒãƒ— (cm)</label><input type="number" id="hip" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>å¤ªã‚‚ã‚‚ (cm)</label><input type="number" id="thigh" step="0.1" inputmode="decimal" placeholder="0.0"></div>
        <div class="form-group"><label>è±†ä¹³ (ml)</label><input type="number" id="soymilk" step="10" inputmode="numeric" placeholder="0"></div>

        <button class="save-btn" onclick="saveData()">è¨˜éŒ²ã™ã‚‹</button>
    </div>

    <div id="tab-graph" class="tab-content">
        <div class="graph-header">
            <select id="graphMetric" class="graph-selector" onchange="displayData()">
                <option value="weight">ä½“é‡</option>
                <option value="bodyfat">ä½“è„‚è‚ªç‡</option>
                <option value="muscle">ç­‹è‚‰é‡</option>
                <option value="bmr">åŸºç¤ä»£è¬é‡</option>
                <option value="bust0">ãƒã‚¹ãƒˆ 0Â°</option>
                <option value="underbust0">ã‚¢ãƒ³ãƒ€ãƒ¼ 0Â°</option>
                <option value="bust30">ãƒã‚¹ãƒˆ 30Â°</option>
                <option value="underbust30">ã‚¢ãƒ³ãƒ€ãƒ¼ 30Â°</option>
                <option value="waist">ã‚¦ã‚¨ã‚¹ãƒˆ</option>
                <option value="hip">ãƒ’ãƒƒãƒ—</option>
                <option value="thigh">å¤ªã‚‚ã‚‚</option>
                <option value="soymilk">è±†ä¹³</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <div id="tab-history" class="tab-content">
        <div class="table-container">
            <table id="recordTable">
                <thead>
                    <tr><th>æ—¥ä»˜</th><th>ä½“é‡</th><th>ä½“è„‚è‚ª</th><th>ç­‹è‚‰é‡</th><th>ä»£è¬</th><th>B(0)</th><th>UB(0)</th><th>B(30)</th><th>UB(30)</th><th>W</th><th>H</th><th>å¤ªã‚‚ã‚‚</th><th>è±†ä¹³</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <h3 style="text-align: center; color: var(--text-main); margin-top: 0;">å„é …ç›®ã®ç›®æ¨™å€¤</h3>
        <div class="form-group"><label>ä½“é‡ (kg)</label><input type="number" id="goal_weight" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ä½“è„‚è‚ªç‡ (%)</label><input type="number" id="goal_bodyfat" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ç­‹è‚‰é‡ (kg)</label><input type="number" id="goal_muscle" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>åŸºç¤ä»£è¬é‡ (kcal)</label><input type="number" id="goal_bmr" step="1" inputmode="numeric"></div>
        <div class="form-group"><label>ãƒã‚¹ãƒˆ 0Â° (cm)</label><input type="number" id="goal_bust0" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ã‚¢ãƒ³ãƒ€ãƒ¼ 0Â° (cm)</label><input type="number" id="goal_underbust0" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ãƒã‚¹ãƒˆ 30Â° (cm)</label><input type="number" id="goal_bust30" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ã‚¢ãƒ³ãƒ€ãƒ¼ 30Â° (cm)</label><input type="number" id="goal_underbust30" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ã‚¦ã‚¨ã‚¹ãƒˆ (cm)</label><input type="number" id="goal_waist" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>ãƒ’ãƒƒãƒ— (cm)</label><input type="number" id="goal_hip" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>å¤ªã‚‚ã‚‚ (cm)</label><input type="number" id="goal_thigh" step="0.1" inputmode="decimal"></div>
        <div class="form-group"><label>è±†ä¹³ (ml)</label><input type="number" id="goal_soymilk" step="10" inputmode="numeric"></div>

        <button class="save-btn" style="background-color: #34c759; margin-bottom: 30px;" onclick="saveGoals()">ç›®æ¨™ã‚’ä¿å­˜</button>

        <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
        <h3 style="text-align: center; color: var(--text-main);">ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»å¼•ãç¶™ã</h3>
        
        <button class="save-btn" style="background-color: #5e5ce6; margin-bottom: 20px;" onclick="exportCSV()">ã‚¨ã‚¯ã‚»ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› (CSV)</button>

        <div style="background: var(--card-color); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <p style="font-size: 0.9em; color: var(--text-sub); margin-top: 0; text-align: center;">ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´æ™‚ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</p>
            <button class="save-btn" style="background-color: #ff9f0a; margin-top: 0; margin-bottom: 10px;" onclick="exportBackup()">å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ (æ›¸ãå‡ºã—)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(event)">
            <button class="save-btn" style="background-color: #ff3b30; margin-top: 0;" onclick="document.getElementById('importFile').click()">å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ (å¾©å…ƒ)</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="switchTab('input', this)"><span class="nav-icon">ğŸ“</span><span>å…¥åŠ›</span></div>
        <div class="nav-item" onclick="switchTab('graph', this)"><span class="nav-icon">ğŸ“ˆ</span><span>ã‚°ãƒ©ãƒ•</span></div>
        <div class="nav-item" onclick="switchTab('history', this)"><span class="nav-icon">ğŸ“‹</span><span>å±¥æ­´</span></div>
        <div class="nav-item" onclick="switchTab('settings', this)"><span class="nav-icon">âš™ï¸</span><span>è¨­å®š</span></div>
    </nav>

    <script>
        let myChartInstance = null;

        const metricInfo = {
            weight: { label: 'ä½“é‡', unit: 'kg' },
            bodyfat: { label: 'ä½“è„‚è‚ªç‡', unit: '%' },
            muscle: { label: 'ç­‹è‚‰é‡', unit: 'kg' },
            bmr: { label: 'åŸºç¤ä»£è¬é‡', unit: 'kcal' },
            bust0: { label: 'ãƒã‚¹ãƒˆ 0Â°', unit: 'cm' },
            underbust0: { label: 'ã‚¢ãƒ³ãƒ€ãƒ¼ 0Â°', unit: 'cm' },
            bust30: { label: 'ãƒã‚¹ãƒˆ 30Â°', unit: 'cm' },
            underbust30: { label: 'ã‚¢ãƒ³ãƒ€ãƒ¼ 30Â°', unit: 'cm' },
            waist: { label: 'ã‚¦ã‚¨ã‚¹ãƒˆ', unit: 'cm' },
            hip: { label: 'ãƒ’ãƒƒãƒ—', unit: 'cm' },
            thigh: { label: 'å¤ªã‚‚ã‚‚', unit: 'cm' },
            soymilk: { label: 'è±†ä¹³', unit: 'ml' }
        };

        window.onload = function() {
            document.getElementById('date').valueAsDate = new Date();
            loadGoals();
            displayData();
        };

        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            element.classList.add('active');
            
            const titles = { 'input': 'è¨˜éŒ²', 'graph': 'ã‚°ãƒ©ãƒ•', 'history': 'å±¥æ­´', 'settings': 'è¨­å®š' };
            document.querySelector('header').textContent = titles[tabId];

            if (tabId === 'graph') displayData(); 
        }

        function saveGoals() {
            const goals = {};
            for (let key in metricInfo) {
                goals[key] = document.getElementById('goal_' + key).value;
            }
            localStorage.setItem('bodyGoals', JSON.stringify(goals));
            alert("ã™ã¹ã¦ã®ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            displayData();
        }

        function loadGoals() {
            const savedGoals = JSON.parse(localStorage.getItem('bodyGoals')) || {};
            for (let key in metricInfo) {
                if(savedGoals[key]) {
                    document.getElementById('goal_' + key).value = savedGoals[key];
                }
            }
        }

        function saveData() {
            const date = document.getElementById('date').value;
            if(!date) return alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const record = { date: date };
            for (let key in metricInfo) {
                record[key] = document.getElementById(key).value;
            }

            let records = JSON.parse(localStorage.getItem('bodyRecords')) || [];
            const index = records.findIndex(r => r.date === date);
            if (index >= 0) records[index] = record; else records.push(record);
            
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('bodyRecords', JSON.stringify(records));
            
            for (let key in metricInfo) document.getElementById(key).value = '';
            
            displayData();
            
            const btn = document.querySelector('#tab-input .save-btn');
            btn.textContent = "ä¿å­˜å®Œäº†ï¼";
            btn.style.backgroundColor = "#34c759";
            setTimeout(() => { btn.textContent = "è¨˜éŒ²ã™ã‚‹"; btn.style.backgroundColor = "var(--accent)"; }, 1500);
        }

        function displayData() {
            let records = JSON.parse(localStorage.getItem('bodyRecords')) || [];
            let tbody = document.querySelector('#recordTable tbody');
            tbody.innerHTML = '';

            records.forEach(record => {
                let rowHtml = `<td>${record.date}</td>`;
                for (let key in metricInfo) {
                    rowHtml += `<td>${record[key] || ''}</td>`;
                }
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;
            });

            if(document.getElementById('tab-graph').classList.contains('active')) {
                drawChart(records);
            }
        }

        function drawChart(records) {
            let chartData = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const selectedMetric = document.getElementById('graphMetric').value;
            const info = metricInfo[selectedMetric];

            const labels = chartData.map(r => r.date.slice(5)); 
            const dataPoints = chartData.map(r => r[selectedMetric] ? parseFloat(r[selectedMetric]) : null);
            
            const savedGoals = JSON.parse(localStorage.getItem('bodyGoals')) || {};
            const targetVal = parseFloat(savedGoals[selectedMetric]);
            
            const targetPoints = labels.map(() => !isNaN(targetVal) ? targetVal : null);

            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChartInstance) myChartInstance.destroy();

            let chartDatasets = [
                { 
                    label: `${info.label} (${info.unit})`, 
                    data: dataPoints, 
                    borderColor: '#0a84ff', 
                    backgroundColor: '#0a84ff', 
                    borderWidth: 3, 
                    pointRadius: 4, 
                    spanGaps: true, 
                    tension: 0.3 
                }
            ];

            if (!isNaN(targetVal)) {
                chartDatasets.push({
                    label: `ç›®æ¨™`, 
                    data: targetPoints, 
                    borderColor: '#34c759', 
                    backgroundColor: '#34c759',
                    borderWidth: 2, 
                    pointRadius: labels.length <= 1 ? 4 : 0, 
                    fill: false
                });
            }

            myChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#ebebf599' } } },
                    scales: {
                        x: { ticks: { color: '#ebebf599' }, grid: { color: '#38383a' } },
                        y: { ticks: { color: '#ebebf599' }, grid: { color: '#38383a' } }
                    }
                }
            });
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆé–²è¦§ãƒ»åˆ†æç”¨ï¼‰
        function exportCSV() {
            let records = JSON.parse(localStorage.getItem('bodyRecords')) || [];
            if(records.length === 0) return alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

            let csvContent = "\uFEFF"; 
            let headers = ["æ—¥ä»˜"];
            for (let key in metricInfo) headers.push(metricInfo[key].label);
            csvContent += headers.join(",") + "\n";

            records.forEach(record => {
                let row = [record.date];
                for (let key in metricInfo) row.push(record[key] || "");
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "smartrecord_data.csv";
            link.click();
        }

        // â˜…æ–°è¦è¿½åŠ : JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›ï¼ˆå¼•ãç¶™ãç”¨ï¼‰
        function exportBackup() {
            const backupData = {
                records: JSON.parse(localStorage.getItem('bodyRecords')) || [],
                goals: JSON.parse(localStorage.getItem('bodyGoals')) || {}
            };
            
            if(backupData.records.length === 0 && Object.keys(backupData.goals).length === 0) {
                return alert("å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            }

            const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "smartrecord_backup.json";
            link.click();
        }

        // â˜…æ–°è¦è¿½åŠ : JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿ï¼ˆå¼•ãç¶™ãå¾©å…ƒï¼‰
        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.records) localStorage.setItem('bodyRecords', JSON.stringify(data.records));
                    if (data.goals) localStorage.setItem('bodyGoals', JSON.stringify(data.goals));
                    
                    loadGoals();
                    displayData();
                    alert("ãƒ‡ãƒ¼ã‚¿ã®å¼•ãç¶™ãï¼ˆå¾©å…ƒï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                } catch (error) {
                    alert("ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„å¼•ãç¶™ããƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.jsonï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                }
            };
            reader.readAsText(file);
            
            // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
            event.target.value = '';
        }
    </script>
</body>
</html>